package main

//Editor Generate
//

import (
	"bufio"
	"bytes"
	"fmt"
	"html/template"
	"strconv"
	"strings"
	"time"

	"github.com/PuerkitoBio/goquery"

	"github.com/gopherjs/gopherjs/js"
	"github.com/gopherjs/jquery"

	"golang.org/x/tools/present"
)

var gblTmpl *template.Template
var jQuery = jquery.NewJQuery

func init() {
	gblTmpl = present.Template()
	funcMap := template.FuncMap{
		"playable": playable,
		"convert":  convert,
	}
	_, err := gblTmpl.Funcs(funcMap).Parse(TMPL)
	if err != nil {
		panic(err)
	}

	present.Register("picture", parsePicture)
}

func main() {

	jQuery(DOCUMENT).Ready(func() {
		draw()
		resize()
	})

	jQuery(js.Global).Resize(func(e jquery.Event) {
		resize()
	})

	jQuery(PUBLISH).On(jquery.CLICK, func(e jquery.Event) {
		ajax("publish")
	})

	jQuery(SAVE).On(jquery.CLICK, func(e jquery.Event) {
		ajax("save")
	})

	jQuery("button#delete").On(jquery.CLICK, func(e jquery.Event) {
		url := "/admin/article/delete/" + jQuery(ARTICLE_ID).Val()
		l := js.Global.Get("location")
		l.Set("href", url)
	})

	jQuery("button#private").On(jquery.CLICK, func(e jquery.Event) {
		ajax("private")
	})

	jQuery("button#viewBtn").On(jquery.CLICK, func(e jquery.Event) {
		url := "/entry/" + jQuery(ARTICLE_ID).Val()
		js.Global.Call("open", url, "_blank")
	})

	jQuery("#saveBGBtn").On(jquery.CLICK, func(e jquery.Event) {
		jQuery("#file").Call("click")
	})

	jQuery("#file").On(jquery.CHANGE, func(e jquery.Event) {
		jQuery("#bgForm").Call("submit")
	})

	auto := jQuery("#AutoSave").Val()

	rd, aj := 0, 0
	go func() {
		t := time.NewTicker(5 * time.Second)
		for {
			select {
			case <-t.C:
				rd = rd + 1
				aj = aj + 1
				flag := false

				if rd == 2 {
					flag = redraw()
					rd = 0
				}

				if auto != "" {
					if aj == 4 {
						if flag {
							ajax("autosave")
						}
						aj = 0
					}
				}
			}
		}
		t.Stop()
	}()
}

func ajax(url string) {

	u := url
	if url == "autosave" {
		u = "save"
	}

	var d *js.Object
	if url != "autosave" {
		d = js.Global.Call("waitDialog")
	}

	id := jQuery(ARTICLE_ID).Val()
	data := js.M{
		"Title":    jQuery(TITLE).Val(),
		"Tags":     jQuery(TAGS).Val(),
		"Markdown": jQuery(INPUT).Val(),
	}

	ajaxopt := js.M{
		"async":    true,
		"type":     "POST",
		"url":      "/admin/article/" + u + "/" + id,
		"dataType": "json",
		"data":     data,
		"success": func(data map[string]interface{}) {
		},
		"error": func(status interface{}) {
		},
		"complete": func(status interface{}) {
			if url != "autosave" {
				d.Call("close")
			} else {
				d = js.Global.Call("toast", "Auto Saved")
			}
		},
	}
	jquery.Ajax(ajaxopt)
}

func resize() {

	height := jQuery(js.Global).Height()

	margin := 230

	out := jQuery(OUTPUT)
	empty := jQuery("img#empty")

	jQuery(LEFT).SetHeight(strconv.Itoa(height - margin))
	jQuery(RIGHT).SetHeight(strconv.Itoa(height - margin))

	jQuery(INPUT).SetHeight(strconv.Itoa(height - margin))
	out.SetHeight(strconv.Itoa(height - margin))

	empty.SetCss("top", out.Css("top"))
	empty.SetCss("left", out.Css("left"))
	empty.SetCss("width", out.Width()-25)
	empty.SetCss("height", out.Height())
}

type Html struct {
	Author    string
	AuthorID  string
	Updater   string
	UpdaterID string
	CreatedAt time.Time
	UpdatedAt time.Time
}

func draw() {
	h := getHtml()

	doc := js.Global.Get("document")
	iframe := doc.Call("getElementById", "result")

	if iframe != nil {
		idoc := iframe.Get("contentDocument")

		idoc.Call("open")
		idoc.Call("write", h)
		idoc.Call("close")

		unbind()
	}
}

var beforeBody = ""

func redraw() bool {

	h := getHtml()
	r := strings.NewReader(h)

	doc, _ := goquery.NewDocumentFromReader(r)
	body := doc.Find("body")

	bh, _ := body.Html()

	if beforeBody != bh {
		jQuery(OUTPUT).Contents().Find("body").SetHtml(bh)
		unbind()
		beforeBody = bh
		return true
	}
	return false
}

func unbind() {
	iframe := jQuery("#result").Contents()
	iframe.Find("a").RemoveAttr("href")
	iframe.Find("button").RemoveAttr("onclick")
}

func getHtml() string {

	title := jQuery(TITLE).Val()

	author := jQuery(AUTHOR).Val()
	job := jQuery(JOB).Val()
	mail := jQuery(EMAIL).Val()
	url := jQuery(URL).Val()
	twitter := "@" + jQuery(TWITTER).Val()

	header := title + "\n\n" +
		author + "\n" +
		job + "\n" +
		mail + "\n" +
		url + "\n" +
		twitter + "\n"

	md := jQuery(INPUT).Val()

	art := header + "\n" + md
	ctx := present.Context{ReadFile: readFile}

	reader := strings.NewReader(art)
	doc, err := ctx.Parse(reader, "blog.article", 0)
	if err != nil {
		return err.Error()
	}

	zero := time.Time{}
	h := Html{
		Author:    author,
		AuthorID:  "empty",
		Updater:   author,
		UpdaterID: "empty",
		CreatedAt: zero,
		UpdatedAt: zero,
	}

	blog := struct {
		Name        string
		Author      string
		Tags        string
		Description string
	}{"Empty", "Empty", "Empty", "Empty"}

	rtn := struct {
		*present.Doc
		Template    *template.Template
		PlayEnabled bool
		StringID    string
		Blog        interface{}
		HTML        Html
	}{doc, gblTmpl, true, jQuery(ARTICLE_ID).Val(), blog, h}

	//Render
	var b bytes.Buffer
	writer := bufio.NewWriter(&b)

	err = gblTmpl.ExecuteTemplate(writer, "root", rtn)
	if err != nil {
		return err.Error()
	}
	writer.Flush()

	return string(b.Bytes())
}

func playable(c present.Code) bool {
	return present.PlayEnabled && c.Play && c.Ext == ".go"
}

func convert(t time.Time) string {
	//jst, _ := time.LoadLocation("Asia/Tokyo")
	//jt := t.In(jst)
	return t.Format("2006/01/02 15:04")
}

func readFile(name string) ([]byte, error) {

	file := "/file/data/" + name
	code := "error"
	ajaxopt := js.M{
		"async":    false,
		"type":     "GET",
		"url":      file,
		"dataType": "text/plain",
		"complete": func(status map[string]interface{}) {
			code = status["responseText"].(string)
		},
	}
	jquery.Ajax(ajaxopt)
	return []byte(code), nil
}

func parsePicture(ctx *present.Context, fileName string, lineno int, text string) (present.Elem, error) {

	args := strings.Fields(text)
	img := present.Image{URL: "/file/data/" + args[1]}
	a, err := parseArgs(fileName, lineno, args[2:])
	if err != nil {
		return nil, err
	}
	switch len(a) {
	case 0:
	case 2:
		if v, ok := a[0].(int); ok {
			img.Height = v
		}
		if v, ok := a[1].(int); ok {
			img.Width = v
		}
	default:
		return nil, fmt.Errorf("incorrect image invocation: %q", text)
	}
	return img, nil

}

func parseArgs(name string, line int, args []string) (res []interface{}, err error) {
	res = make([]interface{}, len(args))
	for i, v := range args {
		if len(v) == 0 {
			return nil, fmt.Errorf("%s:%d bad code argument %q", name, line, v)
		}
		switch v[0] {
		case '0', '1', '2', '3', '4', '5', '6', '7', '8', '9':
			n, err := strconv.Atoi(v)
			if err != nil {
				return nil, fmt.Errorf("%s:%d bad code argument %q", name, line, v)
			}
			res[i] = n
		case '/':
			if len(v) < 2 || v[len(v)-1] != '/' {
				return nil, fmt.Errorf("%s:%d bad code argument %q", name, line, v)
			}
			res[i] = v
		case '$':
			res[i] = "$"
		case '_':
			if len(v) == 1 {
				// Do nothing; "_" indicates an intentionally empty parameter.
				break
			}
			fallthrough
		default:
			return nil, fmt.Errorf("%s:%d bad code argument %q", name, line, v)
		}
	}
	return
}

const (
	TITLE      = "input#Title"
	TAGS       = "input#Tags"
	AUTHOR     = "input#Name"
	JOB        = "input#Job"
	EMAIL      = "input#Email"
	URL        = "input#URL"
	TWITTER    = "input#TwitterId"
	ARTICLE_ID = "input#ID"
	BLOGNAME   = "input#BlogName"
	DOCUMENT   = "document"
	INPUT      = "textarea#editor"
	SAVE       = "button#save"
	PUBLISH    = "button#publish"
	OUTPUT     = "iframe#result"
	LEFT       = "div#left"
	RIGHT      = "div#right"
	TMPL       = `
	{{define "root"}}
<!doctype html>
<html lang="en">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/ fb# article: http://ogp.me/ns/article#">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="{{ .Blog.Description }}">
    <meta name="author" content="{{ .Blog.Author }}">
    <meta name="keywords" content="{{ .Blog.Tags }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:url" content="https://shizuoka-go.appspot.com/entry/{{ .StringID }}" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="{{ .Title }}" />
    <meta property="og:description" content="{{ .Description }}" />
    <meta property="og:site_name" content="{{ .Blog.Name }}" />
    <meta property="og:image" content="https://shizuoka-go.appspot.com/file/bg/{{ .StringID }}" />

    <meta name="twitter:card" content="summary_large_image" />

    <title>{{.Title}} [{{.Blog.Name}}]</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-blue.min.css">
    <link rel="stylesheet" href="/file/data/styles.css">
  </head>

  <body>
    <div class="demo-blog demo-blog--blogpost mdl-layout mdl-js-layout has-drawer is-upgraded">
      <main class="mdl-layout__content">

        <div class="demo-back">
          <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="javascript:history.back()" title="back" role="button">
            <i class="material-icons" role="presentation">arrow_back</i>
          </a>

          <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon right" href="/" title="home" role="button">
            <i class="material-icons" role="presentation">home</i>
          </a>
        </div>

        <div class="demo-blog__posts mdl-grid">
          <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

            <div class="mdl-card__media mdl-color-text--grey-50" style="background-image:url('/file/bg/{{.StringID}}');">
              <h3 class="title">{{.Title}}</h3>
            </div>

<!--
        {{if .Authors}}
          {{range .Authors}}
            <div class="author">
              {{range .Elem}}{{elem $.Template .}}{{end}}
            </div>
          {{end}}
        {{end}}
-->

            <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

              <img class="avatar" src="/file/avatar/{{ .HTML.AuthorID }}" width="48" height="48" onerror="this.src='/images/somebody.jpg'"/>

              <div>
                  <strong style="width:100%;"> {{ .HTML.Author }} </strong>
                  <span> {{ convert  .HTML.CreatedAt }} </span>
              </div>

{{ if .HTML.Updater }}
              <div style="flex-grow:1;"></div>

              <div style="text-align:right;margin-right:10px;">
                <strong style="width:100%">{{ .HTML.Updater }}</strong>
                <span>{{ convert .HTML.UpdatedAt }}</span>
              </div>

              <img class="avatar" src="/file/avatar/{{ .HTML.UpdaterID }}" width="48" height="48" onerror="this.src='/images/somebody.jpg'"/>
{{ end }}

            </div>

            <div class="mdl-color-text--grey-700 mdl-card" style="padding-left:20px;padding-right:20px;padding:bottom:50px;width:100%;">

<!--
        {{with .Sections}}
          <div id="toc">
            {{template "TOC" .}}
          </div>
        {{end}}
-->

        {{range .Sections}}
          {{elem $.Template .}}
        {{end}}

            </div>

          </div>

        </div>

        <footer class="mdl-mini-footer">
          <div class="mdl-mini-footer--left-section">

            <button class="mdl-mini-footer--social-btn social-btn social-btn__twitter" onclick="tweet();">
              <span class="visuallyhidden">Twitter</span>
            </button>

            <button class="mdl-mini-footer--social-btn social-btn social-btn__blogger" onclick="facebook();">
              <span class="visuallyhidden">Facebook</span>
            </button>

          </div>

        </footer>
      </main>

      <div class="mdl-layout__obfuscator"></div>

    </div>

    <a href="javascript:window.scrollTo(0,0);" id="top" class="mdl-button mdl-button--fab mdl-js-button mdl-js-ripple-effect mdl-color--accent mdl-color-text--white"><i class="material-icons">vertical_align_top</i></a>

<script>
    function tweet() {
        var address = location.href;
        var title = document.title;
        var href = "https://twitter.com/share?count=horizontal&amp;original_referer=" + address + "&amp;text=" + title + "&amp;url=" + address;
        window.open(href,'tweetwindow','width=550, height=450,personalbar=0,toolbar=0,scrollbars=1,resizable=1');
        return false;
    }

    function facebook() {
        var address = location.href;
        window.open("http://www.facebook.com/share.php?u=" + address,"facebookwindow","idth=550, height=450,personalbar=0,toolbar=0,scrollbars=1,resizable=1");
        return false;
    }

</script>

  </body>
</html>
{{end}}

<!--
{{define "TOC"}}
  <ul>
  {{range .}}
    <li><a href="#TOC_{{.FormattedNumber}}">{{.Title}}</a></li>
    {{with .Sections}}{{template "TOC" .}}{{end}}
  {{end}}
  </ul>
{{end}}
-->

{{define "newline"}}
{{/* No automatic line break. Paragraphs are free-form. */}}
{{end}}

	{/*
This is the action template.
It determines how the formatting actions are rendered.
*/}

{{define "section"}}
  <h{{len .Number}} id="TOC_{{.FormattedNumber}}">{{.Title}}</h{{len .Number}}>
  {{range .Elem}}{{elem $.Template .}}{{end}}
{{end}}


{{define "list"}}
  <ul>
  {{range .Bullet}}
    <li>{{style .}}</li>
  {{end}}
  </ul>
{{end}}


{{define "text"}}
  {{if .Pre}}
  <div class="code"><pre>{{range .Lines}}{{.}}{{end}}</pre></div>
  {{else}}
  <p>
    {{range $i, $l := .Lines}}{{if $i}}{{template "newline"}}
    {{end}}{{style $l}}{{end}}
  </p>
  {{end}}
{{end}}


{{define "code"}}
  <div class="code{{if playable .}} playground{{end}}" contenteditable="true" spellcheck="false">{{.Text}}</div>
{{end}}


{{define "image"}}
<div class="image">
  <img src="{{.URL}}"{{with .Height}} height="{{.}}"{{end}}{{with .Width}} width="{{.}}"{{end}}>
</div>
{{end}}

{{define "picture"}}
<div class="image">
  <img src="{{.URL}}"{{with .Height}} height="{{.}}"{{end}}{{with .Width}} width="{{.}}"{{end}}>
</div>
{{end}}

{{define "iframe"}}
<iframe src="{{.URL}}"{{with .Height}} height="{{.}}"{{end}}{{with .Width}} width="{{.}}"{{end}}></iframe>
{{end}}

{{define "link"}}<p class="link"><a href="{{.URL}}" target="_blank">{{style .Label}}</a></p>{{end}}

{{define "html"}}{{.HTML}}{{end}}

{{define "caption"}}<figcaption>{{style .Text}}</figcaption>{{end}}


`
)
